/** @format */

// This example shows you how to set up React Stripe.js and use Elements.
// Learn how to accept a payment using the official Stripe docs.
// https://stripe.com/docs/payments/accept-a-payment#web

import React, { useState } from "react";
import { loadStripe } from "@stripe/stripe-js";
import {
  CardNumberElement,
  CardCvcElement,
  CardExpiryElement,
  Elements,
  useElements,
  useStripe,
} from "@stripe/react-stripe-js";

// import { logEvent, Result, ErrorResult } from "./util";
import "./styles/common.css";
import axios from "axios";
import { API_URL, AUTH_NAME } from "../../api";
import Cookies from "js-cookie";
const ELEMENT_OPTIONS = {
  style: {
    base: {
      fontSize: "16px",
      color: "#424770",
      letterSpacing: "0.025em",
      "::placeholder": {
        color: "#aab7c4",
        fontSize: "13px",
        fontWeight: "300",
      },
    },
    invalid: {
      color: "#9e2146",
      border: "red",
    },
  },
  showIcon: true,
};
const logEvent = (name) => (event) => {
  console.log(`[${name}]`, event);
};
const Result = ({ children }) => <div className="result">{children}</div>;
const ErrorResult = ({ children }) => <div className="error">{children}</div>;
const CheckoutForm = () => {
  const userToken = Cookies.get("token");
  const userData = localStorage.getItem("userdata");

  const elements = useElements();
  const stripe = useStripe();
  const [name, setName] = useState("");
  const [postal, setPostal] = useState("");
  const [errorMessage, setErrorMessage] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState(null);

  const handleSubmit = async (event) => {
    event.preventDefault();

    if (!stripe || !elements) {
      // Stripe.js has not loaded yet. Make sure to disable
      // form submission until Stripe.js has loaded.
      return;
    }

    const card = elements.getElement(CardNumberElement);

    if (card == null) {
      return;
    }

    const payload = await stripe.createPaymentMethod({
      type: "card",
      card,
      billing_details: {
        name,
        address: {
          postal_code: postal,
        },
      },
    });

    if (payload.error) {
      console.log("[error]", payload.error);
      setErrorMessage(payload.error.message);
      setPaymentMethod(null);
    } else {
      // console.log("[PaymentMethod]", payload.paymentMethod);
      // setPaymentMethod(payload.paymentMethod);
      setErrorMessage(null);

      // API REQUEST
      console.log("card number", payload.paymentMethod.card);
      if (userToken && userData) {
        const token = JSON.parse(userToken);
        console.log(JSON.parse(userToken));
        const user = JSON.parse(userData);
        console.log(payload.paymentMethod);
        axios
          .post(
            `${API_URL}/subscription/`,
            // Data to send in the request body, if any
            {
              token: "pm_1OoKvQ2eZvKYlo2C0FVi5as6",
              coupon: "f",
              title: "f",
              description: "f",
              paymentMethod: "CB",
              userId: user.id,
              duration: "12",
            },
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json", // Adjust content type as per your API requirements
              },
            }
          )
          .then((response) => {
            // Handle success
            console.log("Response:", response.data);
          })
          .catch((error) => {
            // Handle error
            console.error("Error:", error);
          });
      }
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <label htmlFor="name">Full Name</label>
      <input
        id="name"
        required
        placeholder="Jenny Rosen"
        value={name}
        onChange={(e) => {
          setName(e.target.value);
        }}
      />
      <label htmlFor="cardNumber">Card Number</label>
      <CardNumberElement
        id="cardNumber"
        onBlur={logEvent("blur")}
        onChange={logEvent("change")}
        onFocus={logEvent("focus")}
        onReady={logEvent("ready")}
        options={ELEMENT_OPTIONS}
      />
      <label htmlFor="expiry">Card Expiration</label>
      <CardExpiryElement
        id="expiry"
        onBlur={logEvent("blur")}
        onChange={logEvent("change")}
        onFocus={logEvent("focus")}
        onReady={logEvent("ready")}
        options={ELEMENT_OPTIONS}
      />
      <label htmlFor="cvc">CVC</label>
      <CardCvcElement
        id="cvc"
        onBlur={logEvent("blur")}
        onChange={logEvent("change")}
        onFocus={logEvent("focus")}
        onReady={logEvent("ready")}
        options={ELEMENT_OPTIONS}
      />
      <label htmlFor="postal">Postal Code</label>
      <input
        id="postal"
        required
        placeholder="12345"
        value={postal}
        onChange={(e) => {
          setPostal(e.target.value);
        }}
      />
      {errorMessage && <ErrorResult>{errorMessage}</ErrorResult>}
      {paymentMethod && <Result>Got PaymentMethod: {paymentMethod.id}</Result>}
      <button type="submit" disabled={!stripe}>
        Pay
      </button>
    </form>
  );
};

// Make sure to call `loadStripe` outside of a componentâ€™s render to avoid
// recreating the `Stripe` object on every render.
const stripePromise = loadStripe("pk_test_6pRNASCoBOKtIshFeQd4XMUh");

const CheckoutPage = () => {
  return (
    <div id="checkout">
      <Elements stripe={stripePromise}>
        <CheckoutForm />
      </Elements>
    </div>
  );
};

export default CheckoutPage;
